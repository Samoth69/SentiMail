{% extends "base/base.html" %}
{% load static %}

{% block content %}
  <div class="container">
    <table class="result-table" id="result-table">
        <tr>
            <td class="result-block global" id="score">
                <div class="inner-block">
                    <h1>Result</h1>
                    <p>Score global</p>
                </div>
            </td>
            <td class="result-block" id="uuid">
                <div class="inner-block">
                    <p class ="table-title">UUID </p>
                    <p class ="table-content">{{ email.uuid }}</p>
                </div>
            </td>
        </tr>
        <tr>
            <td class="result-block" id="ip">
                <div class="inner-block">
                    <p class ="table-title">IP</p>
                    <p class ="table-content"></p>
                </div>
            </td>
            <td class="result-block" id="domain">
                <div class="inner-block">
                    <p class ="table-title">Domain</p>
                    <p class ="table-content"></p>
                </div>
            </td>
        </tr>
        <tr>
            <td class="result-block" id="spf">
                <div class="inner-block">
                    <p class ="table-title">SPF</p>
                    <p class ="table-content"></p>
                </div>
            </td>
            <td class="result-block" id="links">
                <div class="inner-block">
                    <p class ="table-title">Links</p>
                    <p class ="table-content"></p>
                </div>
            </td>
        </tr>
        <tr>
            <td class="result-block" id="spelling">
                <div class="inner-block">
                    <p class ="table-title">Spelling</p>
                    <p class ="table-content"></p>
                </div>
            </td>
            <td class="result-block" >
                <div class="inner-block">
                    <p class ="table-title">Keywords</p>
                    <p id="keywords" class ="table-content"><img src="{% static 'base/spin.gif' %"></p>
                </div>
            </td>
        </tr>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <script>
        {% if user.is_authenticated %}
            const url = "http://{{ env }}/api/analysis/" + "{{ email.uuid }}" + "/"
        {% else %}
            const url = "http://{{ env }}/api/result/" + "{{ email.uuid }}" + "/"
        {% endif %}
        function checkAPI(uuid) {
            $.ajax({

                url: url,
                  type: 'GET',
                  success: function (data) {
                        console.log(data);
                        if (data.responseMetadataDomain == "") {
                            setTimeout(function () {
                                checkAPI(uuid);
                            }, 1000);
                        }

                            $('#uuid .table-content').text(data.uuid);
                            $('#ip .table-content').text(data.responseMetadataIp);
                            $('#domain .table-content').text(data.responseMetadataDomain);
                            $('#spf .table-content').text(data.responseMetadataSPF);
                            $('#links .table-content').text(data.responseContentLinks);
                            $('#spelling .table-content').text(data.responseContentSpelling);
                            $("#keywords").text(data.responseContentKeywords);

                      }

            });
        }
        $(document).ready(function () {
            var uuid = '{{ email.uuid }}';
            checkAPI(uuid);
        });
  </script>
{% endblock %}
